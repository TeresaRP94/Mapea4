M.proxy(true);

var mapajs = M.map({
  'container': 'mapjs',
  "controls": ["layerswitcher", "mouse", "scale", "overviewmap", "panzoombar", "scaleline", ],
  "getfeatureinfo": "plain"
});


var municipios = new M.layer.WFS({
  name: "Municipios",
  url: "https://clientes.guadaltel.es/desarrollo/geossigc/wfs?",
  namespace: "mapea",
  name: "da_municipio_pol",
  legend: "Municipios - CATEGORÍAS",
  getfeatureinfo: "plain",
  geometry: 'POLYGON',
  extract: true,
});

mapajs.addLayers(municipios);

municipios.on(M.evt.LOAD, () => alert('municipios cargados'));


// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////


// //cloro polygons

let stylesPolygon = [
    new M.style.Polygon({
    fill: {
      color: 'cyan'
    },
    stroke: {
      color: 'cyan',
      width: 1
    }
  }),
  new M.style.Polygon({
    fill: {
      color: '#337CEB'
    },
    stroke: {
      color: '#337CEB',
      width: 1
    }
  }),
  new M.style.Polygon({
    fill: {
      color: '#1f58ad'
    },
    stroke: {
      color: '#1f58ad',
      width: 1
    }
  }),
  new M.style.Polygon({
    fill: {
      color: '#130668'
    },
    stroke: {
      color: '#130668',
      width: 1
    }
  })
];

let choroplethpol = new M.style.Choropleth("area", stylesPolygon, M.style.quantification.JENKS());

function choropleth() {
  let tiempo_ini = calculafecha();
  municipios.setStyle(choroplethpol);
  let tiempo_fin = calculafecha();
  calculadif(tiempo_ini, tiempo_fin);
}

//
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// //////////////////////          Category      /////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
//

//
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
//
// //CATEGORYSTYLE POLYGON
//
//
let verdep = new M.style.Polygon({
  fill: {
    color: 'green',
  },
  stroke: {
    color: '"black"',
  }
});



let amarillop = new M.style.Polygon({
  fill: {
    color: 'yellow',
  },
  stroke: {
    color: '"black"',
  }
});

let rojop = new M.style.Polygon({
  fill: {
    color: 'red',
  },
  stroke: {
    color: '"black"',
  }
});


let azulp = new M.style.Polygon({
  fill: {
    color: 'blue',
  },
  stroke: {
    color: '"black"',
  }
});

let naranjap = new M.style.Polygon({
  fill: {
    color: 'orange',
  },
  stroke: {
    color: '"black"',
  }
});

let marronp = new M.style.Polygon({
  fill: {
    color: 'brown',
  },
  stroke: {
    color: '"black"',
  }
});

let magentap = new M.style.Polygon({
  fill: {
    color: '#e814d9',
  },
  stroke: {
    color: '"black"',
  }
});

let moradop = new M.style.Polygon({
  fill: {
    color: '#b213dd',
  },
  stroke: {
    color: '"black"',
  }
});



let categoryStylep = new M.style.Category("nom_provincia", {
  "ALMERIA": marronp,
  "CADIZ": amarillop,
  "CORDOBA": magentap,
  "GRANADA": verdep,
  "JAEN": naranjap,
  "MALAGA": azulp,
  "SEVILLA": rojop,
  "HUELVA": moradop
});

function categoryStyle() {

  let tiempo_ini = calculafecha();
  municipios.setStyle(categoryStylep);
  let tiempo_fin = calculafecha();
  calculadif(tiempo_ini, tiempo_fin);

}



// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// //////////////////////          Proportional      //////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////


let proportionalpol = new M.style.Proportional('area', 4, 20, new M.style.Point({
  fill: {
    color: 'blue',
    opacity: 0.5
  },
  stroke: {
    color: 'blue'
  }
}));


function Proportional() {
  let tiempo_ini = calculafecha();
  municipios.setStyle(proportionalpol);
  let tiempo_fin = calculafecha();
  calculadif(tiempo_ini, tiempo_fin);
}

// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// //////////////////////////////      Chart      ////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////
// ///////////////////////////////////////////////////////////////////////////////////////

let chartStyle = new M.style.Chart({
  variables: [new M.style.chart.Variable({
    attribute: 'area',
    label: {
      text: function(curr, tot, feature) {
        return (curr / (curr + feature.getAttribute('area_total'))) + '%'
      },
      stroke: {
        width: 2,
        fill: '#000'
      },
      fill: '#FFF',
      font: 'Comic Sans MS',
    },
    legend: 'Area ocupada por el municicipio'
  }), new M.style.chart.Variable({
    attribute: 'area_total',
    legend: 'Area total de Andalucía'
  })],
  type: M.style.chart.types.PIE,
  radius: 10,
  scheme: M.style.chart.schemes.Classic,
  rotateWithView: true
});

function calcMunicsTotalArea(features) {
  let reduces = features.reduce((tot, curr, i) => {
    if (!(tot instanceof Array)) {
      let oldTot = tot;
      tot = [{
        cod: oldTot.getAttribute('cod_ine_municipio'),
        area: oldTot.getAttribute('area')
      }];
    }
    let munic = tot.find(mun => mun.cod === curr.getAttribute('cod_ine_municipio'));
    if (munic == null) {
      tot.push({
        cod: curr.getAttribute('cod_ine_municipio'),
        area: curr.getAttribute('area')
      });
    } else {
      tot[tot.indexOf(munic)]['area'] += curr.getAttribute('area');
    }
    return tot;
  });
  console.log('munics by cod_ine_municipio', reduces);
  let totalArea = reduces.reduce((tot, curr, i) => {
    if (typeof curr.area === 'number') {
      return (tot.area ? tot.area : tot) + curr.area
    } else {
      console.log('curr without area', curr);
      return tot;
    }
  }) / 1000;
  features.forEach(feature => {
    feature.setAttribute('area_total', totalArea - feature.getAttribute('area'));
  })
}

function Statistics() {
  let wfsLayer = mapajs.getLayers().find(layer => layer.type === 'WFS');
  if (wfsLayer == null) {
    return false;
  }
  calcMunicsTotalArea(wfsLayer.getFeatures());
  let tiempo_ini = calculafecha();
  municipios.setStyle(chartStyle);
  let tiempo_fin = calculafecha();
  calculadif(tiempo_ini, tiempo_fin);
}

function desX() {
  let tiempo_ini = calculafecha();
  municipios.setStyle(amarillop);
  let tiempo_fin = calculafecha();
  calculadif(tiempo_ini, tiempo_fin);
}



function calculadif(tiempo_ini, tiempo_fin) {
  let milisegundos_total = 0;
  let minutos_total = 0;
  let segundos_total = 0;

  let minutos_ini = tiempo_ini.getMinutes();
  let segundos_ini = tiempo_ini.getSeconds();
  let milisegundos_ini = tiempo_ini.getMilliseconds();


  let minutos_fin = tiempo_fin.getMinutes();
  let segundos_fin = tiempo_fin.getSeconds();
  let milisegundos_fin = tiempo_fin.getMilliseconds();

  minutos_total = minutos_fin - minutos_ini;
  segundos_total = segundos_fin - segundos_ini;
  if (milisegundos_fin < milisegundos_ini) {
    milisegundos_total = milisegundos_fin;
  }
  else {
    milisegundos_total = milisegundos_fin - milisegundos_ini;
  }
  console.log("ha tardado: " + minutos_total + " minutos  " + segundos_total + " segundos  " + milisegundos_total + " milisegundos  ")
}


function calculafecha() {
  return new Date();
}
